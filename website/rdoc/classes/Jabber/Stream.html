<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Jabber::Stream</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Jabber::Stream</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/xmpp4r/stream_rb.html">
                lib/xmpp4r/stream.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
The stream class manages a connection stream (a file descriptor using which
XML messages are read and sent)
</p>
<p>
You may register callbacks for the three <a
href="../Jabber.html">Jabber</a> stanzas (message, presence and iq) and use
the <a href="Stream.html#M000442">send</a> and <a
href="Stream.html#M000443">send_with_id</a> methods.
</p>
<p>
To ensure the order of received stanzas, callback blocks are launched in
the parser thread. If further blocking operations are intended in those
callbacks, run your own thread there.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000453">add_iq_callback</a>&nbsp;&nbsp;
      <a href="#M000447">add_message_callback</a>&nbsp;&nbsp;
      <a href="#M000451">add_presence_callback</a>&nbsp;&nbsp;
      <a href="#M000449">add_stanza_callback</a>&nbsp;&nbsp;
      <a href="#M000445">add_xml_callback</a>&nbsp;&nbsp;
      <a href="#M000455">close</a>&nbsp;&nbsp;
      <a href="#M000456">close!</a>&nbsp;&nbsp;
      <a href="#M000454">delete_iq_callback</a>&nbsp;&nbsp;
      <a href="#M000448">delete_message_callback</a>&nbsp;&nbsp;
      <a href="#M000452">delete_presence_callback</a>&nbsp;&nbsp;
      <a href="#M000450">delete_stanza_callback</a>&nbsp;&nbsp;
      <a href="#M000446">delete_xml_callback</a>&nbsp;&nbsp;
      <a href="#M000435">is_connected?</a>&nbsp;&nbsp;
      <a href="#M000436">is_disconnected?</a>&nbsp;&nbsp;
      <a href="#M000429">new</a>&nbsp;&nbsp;
      <a href="#M000432">on_exception</a>&nbsp;&nbsp;
      <a href="#M000433">parse_failure</a>&nbsp;&nbsp;
      <a href="#M000434">parser_end</a>&nbsp;&nbsp;
      <a href="#M000444">poll</a>&nbsp;&nbsp;
      <a href="#M000440">process</a>&nbsp;&nbsp;
      <a href="#M000439">process_one</a>&nbsp;&nbsp;
      <a href="#M000437">receive</a>&nbsp;&nbsp;
      <a href="#M000438">receive_nonthreaded</a>&nbsp;&nbsp;
      <a href="#M000442">send</a>&nbsp;&nbsp;
      <a href="#M000443">send_with_id</a>&nbsp;&nbsp;
      <a href="#M000430">start</a>&nbsp;&nbsp;
      <a href="#M000431">stop</a>&nbsp;&nbsp;
      <a href="#M000441">wait_and_process</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Class <a href="Stream/ThreadBlock.html" class="link">Jabber::Stream::ThreadBlock</a><br />

    </div>

    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DISCONNECTED</td>
          <td>=</td>
          <td class="context-item-value">1</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">CONNECTED</td>
          <td>=</td>
          <td class="context-item-value">2</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">fd</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
file descriptor used

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">status</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
connection status

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000429" class="method-detail">
        <a name="M000429"></a>

        <div class="method-heading">
          <a href="#M000429" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(threaded = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Create a <a href="Stream.html#M000429">new</a> stream (just initializes)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000429-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000429-source">
<pre>
    <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 42</span>
42:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">threaded</span> = <span class="ruby-keyword kw">true</span>)
43:       <span class="ruby-ivar">@fd</span> = <span class="ruby-keyword kw">nil</span>
44:       <span class="ruby-ivar">@status</span> = <span class="ruby-constant">DISCONNECTED</span>
45:       <span class="ruby-ivar">@xmlcbs</span> = <span class="ruby-constant">CallbackList</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span>
46:       <span class="ruby-ivar">@stanzacbs</span> = <span class="ruby-constant">CallbackList</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span>
47:       <span class="ruby-ivar">@messagecbs</span> = <span class="ruby-constant">CallbackList</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span>
48:       <span class="ruby-ivar">@iqcbs</span> = <span class="ruby-constant">CallbackList</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span>
49:       <span class="ruby-ivar">@presencecbs</span> = <span class="ruby-constant">CallbackList</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span>
50:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">threaded</span>
51:         <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Non-threaded mode is currently broken, re-enabling threaded&quot;</span>
52:         <span class="ruby-identifier">threaded</span> = <span class="ruby-keyword kw">true</span>
53:       <span class="ruby-keyword kw">end</span>
54:       <span class="ruby-ivar">@threaded</span> = <span class="ruby-identifier">threaded</span>
55:       <span class="ruby-ivar">@stanzaqueue</span> = []
56:       <span class="ruby-ivar">@stanzaqueue_lock</span> = <span class="ruby-constant">Mutex</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span>
57:       <span class="ruby-ivar">@exception_block</span> = <span class="ruby-keyword kw">nil</span>
58:       <span class="ruby-ivar">@threadblocks</span> = []
59: <span class="ruby-comment cmt">#      @pollCounter = 10</span>
60:       <span class="ruby-ivar">@waiting_thread</span> = <span class="ruby-keyword kw">nil</span>
61:       <span class="ruby-ivar">@wakeup_thread</span> = <span class="ruby-keyword kw">nil</span>
62:       <span class="ruby-ivar">@streamid</span> = <span class="ruby-keyword kw">nil</span>
63:       <span class="ruby-ivar">@features_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
64:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000453" class="method-detail">
        <a name="M000453"></a>

        <div class="method-heading">
          <a href="#M000453" class="method-signature">
          <span class="method-name">add_iq_callback</span><span class="method-args">(priority = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a callback block to <a href="Stream.html#M000440">process</a> received
Iqs
</p>
<table>
<tr><td valign="top">priority:</td><td>[Integer] The callback&#8216;s priority, the higher, the sooner

</td></tr>
<tr><td valign="top">ref:</td><td>[String] The callback&#8216;s reference

</td></tr>
<tr><td valign="top">&amp;block:</td><td>[Block] The optional block

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000453-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000453-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 538</span>
538:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_iq_callback</span>(<span class="ruby-identifier">priority</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
539:       <span class="ruby-ivar">@iqcbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">priority</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
540:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000447" class="method-detail">
        <a name="M000447"></a>

        <div class="method-heading">
          <a href="#M000447" class="method-signature">
          <span class="method-name">add_message_callback</span><span class="method-args">(priority = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a callback block to <a href="Stream.html#M000440">process</a> received
Messages
</p>
<table>
<tr><td valign="top">priority:</td><td>[Integer] The callback&#8216;s priority, the higher, the sooner

</td></tr>
<tr><td valign="top">ref:</td><td>[String] The callback&#8216;s reference

</td></tr>
<tr><td valign="top">&amp;block:</td><td>[Block] The optional block

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000447-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000447-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 484</span>
484:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_message_callback</span>(<span class="ruby-identifier">priority</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
485:       <span class="ruby-ivar">@messagecbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">priority</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
486:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000451" class="method-detail">
        <a name="M000451"></a>

        <div class="method-heading">
          <a href="#M000451" class="method-signature">
          <span class="method-name">add_presence_callback</span><span class="method-args">(priority = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a callback block to <a href="Stream.html#M000440">process</a> received
Presences
</p>
<table>
<tr><td valign="top">priority:</td><td>[Integer] The callback&#8216;s priority, the higher, the sooner

</td></tr>
<tr><td valign="top">ref:</td><td>[String] The callback&#8216;s reference

</td></tr>
<tr><td valign="top">&amp;block:</td><td>[Block] The optional block

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000451-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000451-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 520</span>
520:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_presence_callback</span>(<span class="ruby-identifier">priority</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
521:       <span class="ruby-ivar">@presencecbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">priority</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
522:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000449" class="method-detail">
        <a name="M000449"></a>

        <div class="method-heading">
          <a href="#M000449" class="method-signature">
          <span class="method-name">add_stanza_callback</span><span class="method-args">(priority = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a callback block to <a href="Stream.html#M000440">process</a> received
Stanzas
</p>
<table>
<tr><td valign="top">priority:</td><td>[Integer] The callback&#8216;s priority, the higher, the sooner

</td></tr>
<tr><td valign="top">ref:</td><td>[String] The callback&#8216;s reference

</td></tr>
<tr><td valign="top">&amp;block:</td><td>[Block] The optional block

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000449-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000449-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 502</span>
502:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_stanza_callback</span>(<span class="ruby-identifier">priority</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
503:       <span class="ruby-ivar">@stanzacbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">priority</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
504:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000445" class="method-detail">
        <a name="M000445"></a>

        <div class="method-heading">
          <a href="#M000445" class="method-signature">
          <span class="method-name">add_xml_callback</span><span class="method-args">(priority = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a callback block to <a href="Stream.html#M000440">process</a> received
XML messages
</p>
<table>
<tr><td valign="top">priority:</td><td>[Integer] The callback&#8216;s priority, the higher, the sooner

</td></tr>
<tr><td valign="top">ref:</td><td>[String] The callback&#8216;s reference

</td></tr>
<tr><td valign="top">&amp;block:</td><td>[Block] The optional block

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000445-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000445-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 466</span>
466:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_xml_callback</span>(<span class="ruby-identifier">priority</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
467:       <span class="ruby-ivar">@xmlcbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">priority</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
468:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000455" class="method-detail">
        <a name="M000455"></a>

        <div class="method-heading">
          <a href="#M000455" class="method-signature">
          <span class="method-name">close</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Closes the connection to the <a href="../Jabber.html">Jabber</a> service
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000455-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000455-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 552</span>
552:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
553:       <span class="ruby-identifier">close!</span>
554:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000456" class="method-detail">
        <a name="M000456"></a>

        <div class="method-heading">
          <a href="#M000456" class="method-signature">
          <span class="method-name">close!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000456-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000456-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 556</span>
556:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close!</span>
557:       <span class="ruby-ivar">@parserThread</span>.<span class="ruby-identifier">kill</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@parserThread</span>
558: <span class="ruby-comment cmt">#      @pollThread.kill</span>
559:       <span class="ruby-ivar">@fd</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@fd</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@fd</span>.<span class="ruby-identifier">closed?</span>
560:       <span class="ruby-ivar">@status</span> = <span class="ruby-constant">DISCONNECTED</span>
561:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000454" class="method-detail">
        <a name="M000454"></a>

        <div class="method-heading">
          <a href="#M000454" class="method-signature">
          <span class="method-name">delete_iq_callback</span><span class="method-args">(ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Delete an <a href="Iq.html">Iq</a> callback
</p>
<table>
<tr><td valign="top">ref:</td><td>[String] The reference of the callback to delete

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000454-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000454-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 547</span>
547:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_iq_callback</span>(<span class="ruby-identifier">ref</span>)
548:       <span class="ruby-ivar">@iqcbs</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ref</span>)
549:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000448" class="method-detail">
        <a name="M000448"></a>

        <div class="method-heading">
          <a href="#M000448" class="method-signature">
          <span class="method-name">delete_message_callback</span><span class="method-args">(ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Delete an <a href="Message.html">Message</a> callback
</p>
<table>
<tr><td valign="top">ref:</td><td>[String] The reference of the callback to delete

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000448-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000448-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 492</span>
492:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_message_callback</span>(<span class="ruby-identifier">ref</span>)
493:       <span class="ruby-ivar">@messagecbs</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ref</span>)
494:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000452" class="method-detail">
        <a name="M000452"></a>

        <div class="method-heading">
          <a href="#M000452" class="method-signature">
          <span class="method-name">delete_presence_callback</span><span class="method-args">(ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Delete a <a href="Presence.html">Presence</a> callback
</p>
<table>
<tr><td valign="top">ref:</td><td>[String] The reference of the callback to delete

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000452-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000452-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 528</span>
528:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_presence_callback</span>(<span class="ruby-identifier">ref</span>)
529:       <span class="ruby-ivar">@presencecbs</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ref</span>)
530:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000450" class="method-detail">
        <a name="M000450"></a>

        <div class="method-heading">
          <a href="#M000450" class="method-signature">
          <span class="method-name">delete_stanza_callback</span><span class="method-args">(ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Delete a Stanza callback
</p>
<table>
<tr><td valign="top">ref:</td><td>[String] The reference of the callback to delete

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000450-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000450-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 510</span>
510:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_stanza_callback</span>(<span class="ruby-identifier">ref</span>)
511:       <span class="ruby-ivar">@stanzacbs</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ref</span>)
512:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000446" class="method-detail">
        <a name="M000446"></a>

        <div class="method-heading">
          <a href="#M000446" class="method-signature">
          <span class="method-name">delete_xml_callback</span><span class="method-args">(ref)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Delete an XML-messages callback
</p>
<table>
<tr><td valign="top">ref:</td><td>[String] The reference of the callback to delete

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000446-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000446-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 474</span>
474:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_xml_callback</span>(<span class="ruby-identifier">ref</span>)
475:       <span class="ruby-ivar">@xmlcbs</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ref</span>)
476:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000435" class="method-detail">
        <a name="M000435"></a>

        <div class="method-heading">
          <a href="#M000435" class="method-signature">
          <span class="method-name">is_connected?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns if this connection is connected to a <a
href="../Jabber.html">Jabber</a> service
</p>
<table>
<tr><td valign="top">return:</td><td>[Boolean] <a href="Connection.html">Connection</a> status

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000435-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000435-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 158</span>
158:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_connected?</span>
159:       <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@status</span> <span class="ruby-operator">==</span> <span class="ruby-constant">CONNECTED</span>
160:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000436" class="method-detail">
        <a name="M000436"></a>

        <div class="method-heading">
          <a href="#M000436" class="method-signature">
          <span class="method-name">is_disconnected?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns if this connection is NOT connected to a <a
href="../Jabber.html">Jabber</a> service
</p>
<table>
<tr><td valign="top">return:</td><td>[Boolean] <a href="Connection.html">Connection</a> status

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000436-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000436-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 166</span>
166:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_disconnected?</span>
167:       <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@status</span> <span class="ruby-operator">==</span> <span class="ruby-constant">DISCONNECTED</span>
168:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000432" class="method-detail">
        <a name="M000432"></a>

        <div class="method-heading">
          <a href="#M000432" class="method-signature">
          <span class="method-name">on_exception</span><span class="method-args">(&amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Mounts a block to handle exceptions if they occur during the <a
href="Stream.html#M000444">poll</a> <a href="Stream.html#M000442">send</a>.
This will likely be the first indication that the socket dropped in a <a
href="../Jabber.html">Jabber</a> Session.
</p>
<p>
The block has to take three arguments:
</p>
<ul>
<li>the Exception

</li>
<li>the <a href="Stream.html">Jabber::Stream</a> object (self)

</li>
<li>a symbol where it happened, namely :<a
href="Stream.html#M000430">start</a>, :parser, :sending and :end

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000432-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000432-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 116</span>
116:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">on_exception</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
117:       <span class="ruby-ivar">@exception_block</span> = <span class="ruby-identifier">block</span>
118:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000433" class="method-detail">
        <a name="M000433"></a>

        <div class="method-heading">
          <a href="#M000433" class="method-signature">
          <span class="method-name">parse_failure</span><span class="method-args">(e)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method is called by the parser when a failure occurs
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000433-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000433-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 122</span>
122:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_failure</span>(<span class="ruby-identifier">e</span>)
123:       <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-node">&quot;EXCEPTION:\n#{e.class}\n#{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</span>)
124: 
125:       <span class="ruby-comment cmt"># A new thread has to be created because close will cause the thread</span>
126:       <span class="ruby-comment cmt"># to commit suicide(???)</span>
127:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@exception_block</span>
128:         <span class="ruby-comment cmt"># New thread, because close will kill the current thread</span>
129:         <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
130:           <span class="ruby-identifier">close</span>
131:           <span class="ruby-ivar">@exception_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">e</span>, <span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:parser</span>)
132:         }
133:       <span class="ruby-keyword kw">else</span>
134:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Stream#parse_failure was called by XML parser. Dumping &quot;</span> <span class="ruby-operator">+</span>
135:         <span class="ruby-value str">&quot;backtrace...\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">exception</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;\n&quot;</span>
136:         <span class="ruby-identifier">puts</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>
137:         <span class="ruby-identifier">close</span>
138:         <span class="ruby-identifier">raise</span>
139:       <span class="ruby-keyword kw">end</span>
140:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000434" class="method-detail">
        <a name="M000434"></a>

        <div class="method-heading">
          <a href="#M000434" class="method-signature">
          <span class="method-name">parser_end</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method is called by the parser upon receiving
<tt>&lt;/stream:stream&gt;</tt>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000434-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000434-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 144</span>
144:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parser_end</span>
145:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@exception_block</span>
146:         <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
147:           <span class="ruby-identifier">close</span>
148:           <span class="ruby-ivar">@exception_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword kw">nil</span>, <span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:close</span>)
149:         }
150:       <span class="ruby-keyword kw">else</span>
151:         <span class="ruby-identifier">close</span>
152:       <span class="ruby-keyword kw">end</span>
153:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000444" class="method-detail">
        <a name="M000444"></a>

        <div class="method-heading">
          <a href="#M000444" class="method-signature">
          <span class="method-name">poll</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Starts a polling thread to <a href="Stream.html#M000442">send</a>
&quot;keep alive&quot; data to prevent the <a
href="../Jabber.html">Jabber</a> connection from closing for inactivity.
</p>
<p>
Currently not working!
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000444-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000444-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 444</span>
444:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">poll</span>
445:       <span class="ruby-identifier">sleep</span> <span class="ruby-value">10</span>
446:       <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
447:         <span class="ruby-identifier">sleep</span> <span class="ruby-value">2</span>
448: <span class="ruby-comment cmt">#        @pollCounter = @pollCounter - 1</span>
449: <span class="ruby-comment cmt">#        if @pollCounter &lt; 0</span>
450: <span class="ruby-comment cmt">#          begin</span>
451: <span class="ruby-comment cmt">#            send(&quot;  \t  &quot;)</span>
452: <span class="ruby-comment cmt">#          rescue</span>
453: <span class="ruby-comment cmt">#            Thread.new {@exception_block.call if @exception_block}</span>
454: <span class="ruby-comment cmt">#            break</span>
455: <span class="ruby-comment cmt">#          end</span>
456: <span class="ruby-comment cmt">#        end</span>
457:       <span class="ruby-keyword kw">end</span>
458:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000440" class="method-detail">
        <a name="M000440"></a>

        <div class="method-heading">
          <a href="#M000440" class="method-signature">
          <span class="method-name">process</span><span class="method-args">(max = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Process |max| XML stanzas and call listeners for all of them.
</p>
<table>
<tr><td valign="top">max:</td><td>[Integer] the number of stanzas to <a
href="Stream.html#M000440">process</a> (nil means <a
href="Stream.html#M000440">process</a>

</td></tr>
</table>
<p>
all available)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000440-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000440-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 289</span>
289:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">max</span> = <span class="ruby-keyword kw">nil</span>)
290:       <span class="ruby-identifier">n</span> = <span class="ruby-value">0</span>
291:       <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">lock</span>
292:       <span class="ruby-keyword kw">while</span> <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">and</span> (<span class="ruby-identifier">max</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">n</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">max</span>)
293:         <span class="ruby-identifier">e</span> = <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">shift</span>
294:         <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">unlock</span>
295:         <span class="ruby-identifier">process_one</span>(<span class="ruby-identifier">e</span>)
296:         <span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
297:         <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">lock</span>
298:       <span class="ruby-keyword kw">end</span>
299:       <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">unlock</span>
300:       <span class="ruby-identifier">n</span>
301:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000437" class="method-detail">
        <a name="M000437"></a>

        <div class="method-heading">
          <a href="#M000437" class="method-signature">
          <span class="method-name">receive</span><span class="method-args">(element)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Processes a received <a href="../REXML/Element.html">REXML::Element</a> and
executes registered thread blocks and filters against it.
</p>
<p>
If in threaded mode, a <a href="Stream.html#M000429">new</a> thread will be
spawned for the call to <a
href="Stream.html#M000438">receive_nonthreaded</a>.
</p>
<table>
<tr><td valign="top">element:</td><td>[<a href="../REXML/Element.html">REXML::Element</a>] The received element

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000437-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000437-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 177</span>
177:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive</span>(<span class="ruby-identifier">element</span>)
178:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@threaded</span>
179:         <span class="ruby-comment cmt"># Don't spawn a new thread here. An implicit feature</span>
180:         <span class="ruby-comment cmt"># of XMPP is constant order of stanzas.</span>
181:         <span class="ruby-identifier">receive_nonthreaded</span>(<span class="ruby-identifier">element</span>)
182:       <span class="ruby-keyword kw">else</span>
183:         <span class="ruby-identifier">receive_nonthreaded</span>(<span class="ruby-identifier">element</span>)
184:       <span class="ruby-keyword kw">end</span>
185:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000442" class="method-detail">
        <a name="M000442"></a>

        <div class="method-heading">
          <a href="#M000442" class="method-signature">
          <span class="method-name">send</span><span class="method-args">(xml, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sends XML data to the socket and (optionally) waits to <a
href="Stream.html#M000440">process</a> received data.
</p>
<p>
Do not invoke this in a callback but in a seperate thread because we may
not suspend the parser-thread (in whose context callbacks are executed).
</p>
<table>
<tr><td valign="top">xml:</td><td>[String] The xml data to <a href="Stream.html#M000442">send</a>

</td></tr>
<tr><td valign="top">&amp;block:</td><td>[Block] The optional block

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000442-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000442-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 369</span>
369:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send</span>(<span class="ruby-identifier">xml</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
370:       <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-node">&quot;SENDING:\n#{xml}&quot;</span>)
371:       <span class="ruby-ivar">@threadblocks</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-constant">ThreadBlock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">block</span>)) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block</span>
372:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">critical</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-comment cmt"># we don't want to be interupted before we stop!</span>
373:       <span class="ruby-keyword kw">begin</span>
374:         <span class="ruby-ivar">@fd</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">to_s</span>
375:         <span class="ruby-ivar">@fd</span>.<span class="ruby-identifier">flush</span>
376:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
377:         <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-node">&quot;EXCEPTION:\n#{e.class}\n#{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</span>)
378: 
379:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@exception_block</span> 
380:           <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">close!</span>; <span class="ruby-ivar">@exception_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">e</span>, <span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:sending</span>) }
381:         <span class="ruby-keyword kw">else</span>
382:           <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Exception caught while sending!&quot;</span>
383:           <span class="ruby-identifier">close!</span>
384:           <span class="ruby-identifier">raise</span>
385:         <span class="ruby-keyword kw">end</span>
386:       <span class="ruby-keyword kw">end</span>
387:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">critical</span> = <span class="ruby-keyword kw">false</span>
388:       <span class="ruby-comment cmt"># The parser thread might be running this (think of a callback running send())</span>
389:       <span class="ruby-comment cmt"># If this is the case, we mustn't stop (or we would cause a deadlock)</span>
390:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">stop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block</span> <span class="ruby-keyword kw">and</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@parserThread</span>
391:       <span class="ruby-ivar">@pollCounter</span> = <span class="ruby-value">10</span>
392:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000443" class="method-detail">
        <a name="M000443"></a>

        <div class="method-heading">
          <a href="#M000443" class="method-signature">
          <span class="method-name">send_with_id</span><span class="method-args">(xml) {|received| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Send an XMMP stanza with an <a
href="XMLStanza.html#M000415">Jabber::XMLStanza#id</a>. The id will be
generated by <a href="IdGenerator.html">Jabber::IdGenerator</a> if not
already set.
</p>
<p>
The block will be called once: when receiving a stanza with the same
Jabber::XMPPStanza#id. There is no need to return true to complete this!
Instead the return value of the block will be returned.
</p>
<p>
Be aware that if a stanza with <tt>type=&#8216;error&#8216;</tt> is
received the function does not yield but raises an <a
href="ErrorException.html">ErrorException</a> with the corresponding error
element.
</p>
<p>
Please see <a href="Stream.html#M000442">Stream#send</a> for some
implementational details.
</p>
<p>
Please read the note about nesting at <a
href="Stream.html#M000442">Stream#send</a>
</p>
<table>
<tr><td valign="top">xml:</td><td>[<a href="XMLStanza.html">XMLStanza</a>]

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000443-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000443-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 411</span>
411:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_with_id</span>(<span class="ruby-identifier">xml</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
412:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">nil?</span>
413:         <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">id</span> = <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-constant">IdGenerator</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">generate_id</span>
414:       <span class="ruby-keyword kw">end</span>
415: 
416:       <span class="ruby-identifier">res</span> = <span class="ruby-keyword kw">nil</span>
417:       <span class="ruby-identifier">error</span> = <span class="ruby-keyword kw">nil</span>
418:       <span class="ruby-identifier">send</span>(<span class="ruby-identifier">xml</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">received</span><span class="ruby-operator">|</span>
419:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">received</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">XMLStanza</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">received</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">id</span>
420:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">received</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:error</span>
421:             <span class="ruby-identifier">error</span> = (<span class="ruby-identifier">received</span>.<span class="ruby-identifier">error</span> <span class="ruby-value">? </span><span class="ruby-identifier">received</span>.<span class="ruby-identifier">error</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Error</span>.<span class="ruby-identifier">new</span>)
422:             <span class="ruby-keyword kw">true</span>
423:           <span class="ruby-keyword kw">else</span>
424:             <span class="ruby-identifier">res</span> = <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">received</span>)
425:             <span class="ruby-keyword kw">true</span>
426:           <span class="ruby-keyword kw">end</span>
427:         <span class="ruby-keyword kw">else</span>
428:           <span class="ruby-keyword kw">false</span>
429:         <span class="ruby-keyword kw">end</span>
430:       <span class="ruby-keyword kw">end</span>
431: 
432:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">nil?</span>
433:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ErrorException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">error</span>)
434:       <span class="ruby-keyword kw">end</span>
435: 
436:       <span class="ruby-identifier">res</span>
437:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000430" class="method-detail">
        <a name="M000430"></a>

        <div class="method-heading">
          <a href="#M000430" class="method-signature">
          <span class="method-name">start</span><span class="method-args">(fd)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Start the XML parser on the fd
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000430-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000430-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 68</span>
 68:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>(<span class="ruby-identifier">fd</span>)
 69:       <span class="ruby-ivar">@stream_mechanisms</span> = []
 70:       <span class="ruby-ivar">@stream_features</span> = {}
 71: 
 72:       <span class="ruby-ivar">@fd</span> = <span class="ruby-identifier">fd</span>
 73:       <span class="ruby-ivar">@parser</span> = <span class="ruby-constant">StreamParser</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@fd</span>, <span class="ruby-keyword kw">self</span>)
 74:       <span class="ruby-ivar">@parserThread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
 75:         <span class="ruby-keyword kw">begin</span>
 76:           <span class="ruby-ivar">@parser</span>.<span class="ruby-identifier">parse</span>
 77:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
 78:           <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-node">&quot;EXCEPTION:\n#{e.class}\n#{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</span>)
 79: 
 80:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@exception_block</span>
 81:             <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">close</span>; <span class="ruby-ivar">@exception_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">e</span>, <span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">:start</span>) }
 82:           <span class="ruby-keyword kw">else</span>
 83:             <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;Exception caught in Parser thread!&quot;</span>
 84:             <span class="ruby-identifier">close</span>
 85:             <span class="ruby-identifier">raise</span>
 86:           <span class="ruby-keyword kw">end</span>
 87:         <span class="ruby-keyword kw">end</span>
 88:       <span class="ruby-keyword kw">end</span>
 89: <span class="ruby-comment cmt">#      @pollThread = Thread.new do</span>
 90: <span class="ruby-comment cmt">#        begin</span>
 91: <span class="ruby-comment cmt">#        poll</span>
 92: <span class="ruby-comment cmt">#        rescue</span>
 93: <span class="ruby-comment cmt">#          puts &quot;Exception caught in Poll thread, dumping backtrace and&quot; +</span>
 94: <span class="ruby-comment cmt">#            &quot; exiting...\n&quot; + $!.exception + &quot;\n&quot;</span>
 95: <span class="ruby-comment cmt">#          puts $!.backtrace</span>
 96: <span class="ruby-comment cmt">#          exit</span>
 97: <span class="ruby-comment cmt">#        end</span>
 98: <span class="ruby-comment cmt">#      end</span>
 99:       <span class="ruby-ivar">@status</span> = <span class="ruby-constant">CONNECTED</span>
100:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000431" class="method-detail">
        <a name="M000431"></a>

        <div class="method-heading">
          <a href="#M000431" class="method-signature">
          <span class="method-name">stop</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000431-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000431-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 102</span>
102:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop</span>
103:       <span class="ruby-ivar">@parserThread</span>.<span class="ruby-identifier">kill</span>
104:       <span class="ruby-ivar">@parser</span> = <span class="ruby-keyword kw">nil</span>
105:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000441" class="method-detail">
        <a name="M000441"></a>

        <div class="method-heading">
          <a href="#M000441" class="method-signature">
          <span class="method-name">wait_and_process</span><span class="method-args">(time = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Process an XML stanza and call the listeners for it. If no stanza is
currently available, wait for max |time| seconds before returning.
</p>
<table>
<tr><td valign="top">time:</td><td>[Integer] time to wait in seconds. If nil, wait infinitely.

</td></tr>
</table>
<p>
all available)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000441-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000441-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 309</span>
309:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait_and_process</span>(<span class="ruby-identifier">time</span> = <span class="ruby-keyword kw">nil</span>)
310:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">time</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> 
311:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">process</span>(<span class="ruby-value">1</span>)
312:       <span class="ruby-keyword kw">end</span>
313:       <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">lock</span>
314:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
315:         <span class="ruby-identifier">e</span> = <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">shift</span>
316:         <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">unlock</span>
317:         <span class="ruby-identifier">process_one</span>(<span class="ruby-identifier">e</span>)
318:         <span class="ruby-keyword kw">return</span> <span class="ruby-value">1</span>
319:       <span class="ruby-keyword kw">end</span>
320: 
321:       <span class="ruby-ivar">@waiting_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>
322:       <span class="ruby-ivar">@wakeup_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">sleep</span> <span class="ruby-identifier">time</span> ; <span class="ruby-ivar">@waiting_thread</span>.<span class="ruby-identifier">wakeup</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@waiting_thread</span> }
323:       <span class="ruby-ivar">@waiting_thread</span>.<span class="ruby-identifier">stop</span>
324:       <span class="ruby-ivar">@wakeup_thread</span>.<span class="ruby-identifier">kill</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@wakeup_thread</span>
325:       <span class="ruby-ivar">@wakeup_thread</span> = <span class="ruby-keyword kw">nil</span>
326:       <span class="ruby-ivar">@waiting_thread</span> = <span class="ruby-keyword kw">nil</span>
327: 
328:       <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">lock</span>
329:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
330:         <span class="ruby-identifier">e</span> = <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">shift</span>
331:         <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">unlock</span>
332:         <span class="ruby-identifier">process_one</span>(<span class="ruby-identifier">e</span>)
333:         <span class="ruby-keyword kw">return</span> <span class="ruby-value">1</span>
334:       <span class="ruby-keyword kw">end</span>
335:       <span class="ruby-keyword kw">return</span> <span class="ruby-value">0</span>
336:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Private Instance methods</h3>

      <div id="method-M000439" class="method-detail">
        <a name="M000439"></a>

        <div class="method-heading">
          <a href="#M000439" class="method-signature">
          <span class="method-name">process_one</span><span class="method-args">(stanza)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Process |element| until it is consumed. Returns element.consumed? element
The element to <a href="Stream.html#M000440">process</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000439-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000439-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 269</span>
269:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_one</span>(<span class="ruby-identifier">stanza</span>)
270:       <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-node">&quot;PROCESSING:\n#{stanza.to_s}&quot;</span>)
271:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@xmlcbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">stanza</span>)
272:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@stanzacbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">stanza</span>)
273:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">stanza</span>
274:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Message</span>
275:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@messagecbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">stanza</span>)
276:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Iq</span>
277:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@iqcbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">stanza</span>)
278:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Presence</span>
279:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@presencecbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">stanza</span>)
280:       <span class="ruby-keyword kw">end</span>
281:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000438" class="method-detail">
        <a name="M000438"></a>

        <div class="method-heading">
          <a href="#M000438" class="method-signature">
          <span class="method-name">receive_nonthreaded</span><span class="method-args">(element)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000438-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000438-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/stream.rb, line 187</span>
187:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_nonthreaded</span>(<span class="ruby-identifier">element</span>)
188:       <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-node">&quot;RECEIVED:\n#{element.to_s}&quot;</span>)
189:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">prefix</span>
190:       <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'stream'</span>
191:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>
192:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'stream'</span>
193:             <span class="ruby-identifier">stanza</span> = <span class="ruby-identifier">element</span>
194:             <span class="ruby-ivar">@streamid</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-value str">'id'</span>]
195:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-value str">'version'</span>]  <span class="ruby-comment cmt"># isn't XMPP compliant, so</span>
196:               <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-value str">&quot;FEATURES: server not XMPP compliant, will not wait for features&quot;</span>)
197:               <span class="ruby-ivar">@features_lock</span>.<span class="ruby-identifier">unlock</span>               <span class="ruby-comment cmt"># don't wait for &lt;stream:features/&gt;</span>
198:             <span class="ruby-keyword kw">end</span>
199:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'features'</span>
200:             <span class="ruby-identifier">stanza</span> = <span class="ruby-identifier">element</span>
201:             <span class="ruby-identifier">element</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span>
202:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'mechanisms'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">namespace</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'urn:ietf:params:xml:ns:xmpp-sasl'</span>
203:                 <span class="ruby-identifier">e</span>.<span class="ruby-identifier">each_element</span>(<span class="ruby-value str">'mechanism'</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">mech</span><span class="ruby-operator">|</span>
204:                   <span class="ruby-ivar">@stream_mechanisms</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">mech</span>.<span class="ruby-identifier">text</span>)
205:                 }
206:               <span class="ruby-keyword kw">else</span>
207:                 <span class="ruby-ivar">@stream_features</span>[<span class="ruby-identifier">e</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">namespace</span>
208:               <span class="ruby-keyword kw">end</span>
209:             }
210:             <span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-identifier">debuglog</span>(<span class="ruby-value str">&quot;FEATURES: received&quot;</span>)
211:             <span class="ruby-ivar">@features_lock</span>.<span class="ruby-identifier">unlock</span>
212:           <span class="ruby-keyword kw">else</span>
213:             <span class="ruby-identifier">stanza</span> = <span class="ruby-identifier">element</span>
214:         <span class="ruby-keyword kw">end</span>
215:       <span class="ruby-keyword kw">else</span>
216:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>
217:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'message'</span>
218:             <span class="ruby-identifier">stanza</span> = <span class="ruby-constant">Message</span><span class="ruby-operator">::</span><span class="ruby-identifier">import</span>(<span class="ruby-identifier">element</span>)
219:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'iq'</span>
220:             <span class="ruby-identifier">stanza</span> = <span class="ruby-constant">Iq</span><span class="ruby-operator">::</span><span class="ruby-identifier">import</span>(<span class="ruby-identifier">element</span>)
221:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'presence'</span>
222:             <span class="ruby-identifier">stanza</span> = <span class="ruby-constant">Presence</span><span class="ruby-operator">::</span><span class="ruby-identifier">import</span>(<span class="ruby-identifier">element</span>)
223:           <span class="ruby-keyword kw">else</span>
224:             <span class="ruby-identifier">stanza</span> = <span class="ruby-identifier">element</span>
225:         <span class="ruby-keyword kw">end</span>
226:       <span class="ruby-keyword kw">end</span>
227: 
228:       <span class="ruby-comment cmt"># Iterate through blocked threads (= waiting for an answer)</span>
229:       <span class="ruby-comment cmt">#</span>
230:       <span class="ruby-comment cmt"># We're dup'ping the @threadblocks here, so that we won't end up in an</span>
231:       <span class="ruby-comment cmt"># endless loop if Stream#send is being nested. That means, the nested</span>
232:       <span class="ruby-comment cmt"># threadblock won't receive the stanza currently processed, but the next</span>
233:       <span class="ruby-comment cmt"># one.</span>
234:       <span class="ruby-identifier">threadblocks</span> = <span class="ruby-ivar">@threadblocks</span>.<span class="ruby-identifier">dup</span>
235:       <span class="ruby-identifier">threadblocks</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">threadblock</span><span class="ruby-operator">|</span>
236:         <span class="ruby-identifier">exception</span> = <span class="ruby-keyword kw">nil</span>
237:         <span class="ruby-identifier">r</span> = <span class="ruby-keyword kw">false</span>
238:         <span class="ruby-keyword kw">begin</span>
239:           <span class="ruby-identifier">r</span> = <span class="ruby-identifier">threadblock</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">stanza</span>)
240:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
241:           <span class="ruby-identifier">exception</span> = <span class="ruby-identifier">e</span>
242:         <span class="ruby-keyword kw">end</span>
243: 
244:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>
245:           <span class="ruby-ivar">@threadblocks</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">threadblock</span>)
246:           <span class="ruby-identifier">threadblock</span>.<span class="ruby-identifier">wakeup</span>
247:           <span class="ruby-keyword kw">return</span>
248:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">exception</span>
249:           <span class="ruby-ivar">@threadblocks</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">threadblock</span>)
250:           <span class="ruby-identifier">threadblock</span>.<span class="ruby-identifier">raise</span>(<span class="ruby-identifier">exception</span>)
251:         <span class="ruby-keyword kw">end</span>
252:       }
253: 
254:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@threaded</span>
255:         <span class="ruby-identifier">process_one</span>(<span class="ruby-identifier">stanza</span>)
256:       <span class="ruby-keyword kw">else</span>
257:         <span class="ruby-comment cmt"># stanzaqueue will be read when the user call process</span>
258:         <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">lock</span>
259:         <span class="ruby-ivar">@stanzaqueue</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">stanza</span>)
260:         <span class="ruby-ivar">@stanzaqueue_lock</span>.<span class="ruby-identifier">unlock</span>
261:         <span class="ruby-ivar">@waiting_thread</span>.<span class="ruby-identifier">wakeup</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@waiting_thread</span>
262:       <span class="ruby-keyword kw">end</span>
263:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>