<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Jabber::Roster::Helper</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Jabber::Roster::Helper</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/xmpp4r/roster/helper/roster_rb.html">
                lib/xmpp4r/roster/helper/roster.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
The <a href="../Roster.html">Roster</a> helper intercepts
<tt>&lt;iq/&gt;</tt> stanzas with Jabber::IqQueryRoster and
<tt>&lt;presence/&gt;</tt> stanzas, but provides cbs which allow the
programmer to keep track of updates.
</p>
<p>
A thread for any received stanza is spawned, so the user can invoke <a
href="Helper.html#M000178">accept_subscription</a> et al in the callback
blocks, without stopping the current (= parser) thread when waiting for a
reply.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000173">[]</a>&nbsp;&nbsp;
      <a href="#M000178">accept_subscription</a>&nbsp;&nbsp;
      <a href="#M000177">add</a>&nbsp;&nbsp;
      <a href="#M000167">add_presence_callback</a>&nbsp;&nbsp;
      <a href="#M000165">add_query_callback</a>&nbsp;&nbsp;
      <a href="#M000168">add_subscription_callback</a>&nbsp;&nbsp;
      <a href="#M000169">add_subscription_request_callback</a>&nbsp;&nbsp;
      <a href="#M000166">add_update_callback</a>&nbsp;&nbsp;
      <a href="#M000179">decline_subscription</a>&nbsp;&nbsp;
      <a href="#M000174">find</a>&nbsp;&nbsp;
      <a href="#M000176">find_by_group</a>&nbsp;&nbsp;
      <a href="#M000175">groups</a>&nbsp;&nbsp;
      <a href="#M000170">handle_iq</a>&nbsp;&nbsp;
      <a href="#M000171">handle_presence</a>&nbsp;&nbsp;
      <a href="#M000164">new</a>&nbsp;&nbsp;
      <a href="#M000172">update_presence</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Class <a href="Helper/RosterItem.html" class="link">Jabber::Roster::Helper::RosterItem</a><br />

    </div>




    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">items</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
All items in your roster

<table>
<tr><td valign="top">items:</td><td>[Hash] ([<a href="../JID.html">JID</a>] =&gt; [<a
href="Helper/RosterItem.html">Roster::Helper::RosterItem</a>])

</td></tr>
</table>
</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000164" class="method-detail">
        <a name="M000164"></a>

        <div class="method-heading">
          <a href="#M000164" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(stream)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Initialize a <a href="Helper.html#M000164">new</a> <a
href="../Roster.html">Roster</a> helper
</p>
<p>
Registers its cbs (prio = 120, ref = self)
</p>
<p>
Request a roster (Remember to send initial presence afterwards!)
</p>
<p>
The initialization will not wait for the roster being received, use <a
href="Helper.html#M000165">add_query_callback</a> to get notifyed when
Roster::Helper#items has been filled.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000164-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000164-source">
<pre>
    <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 36</span>
36:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">stream</span>)
37:         <span class="ruby-ivar">@stream</span> = <span class="ruby-identifier">stream</span>
38:         <span class="ruby-ivar">@items</span> = {}
39:         <span class="ruby-ivar">@items_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
40:         <span class="ruby-ivar">@query_cbs</span> = <span class="ruby-constant">CallbackList</span>.<span class="ruby-identifier">new</span>
41:         <span class="ruby-ivar">@update_cbs</span> = <span class="ruby-constant">CallbackList</span>.<span class="ruby-identifier">new</span>
42:         <span class="ruby-ivar">@presence_cbs</span> = <span class="ruby-constant">CallbackList</span>.<span class="ruby-identifier">new</span>
43:         <span class="ruby-ivar">@subscription_cbs</span> = <span class="ruby-constant">CallbackList</span>.<span class="ruby-identifier">new</span>
44:         <span class="ruby-ivar">@subscription_request_cbs</span> = <span class="ruby-constant">CallbackList</span>.<span class="ruby-identifier">new</span>
45: 
46:         <span class="ruby-comment cmt"># Register cbs</span>
47:         <span class="ruby-identifier">stream</span>.<span class="ruby-identifier">add_iq_callback</span>(<span class="ruby-value">120</span>, <span class="ruby-keyword kw">self</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">iq</span><span class="ruby-operator">|</span>
48:           <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
49:             <span class="ruby-identifier">handle_iq</span>(<span class="ruby-identifier">iq</span>)
50:           <span class="ruby-keyword kw">end</span>
51:         }
52:         <span class="ruby-identifier">stream</span>.<span class="ruby-identifier">add_presence_callback</span>(<span class="ruby-value">120</span>, <span class="ruby-keyword kw">self</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">pres</span><span class="ruby-operator">|</span>
53:           <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
54:             <span class="ruby-identifier">handle_presence</span>(<span class="ruby-identifier">pres</span>)
55:           <span class="ruby-keyword kw">end</span>
56:         }
57: 
58:         <span class="ruby-comment cmt"># Request the roster</span>
59:         <span class="ruby-identifier">rosterget</span> = <span class="ruby-constant">Iq</span>.<span class="ruby-identifier">new_rosterget</span>
60:         <span class="ruby-identifier">stream</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">rosterget</span>)
61:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000173" class="method-detail">
        <a name="M000173"></a>

        <div class="method-heading">
          <a href="#M000173" class="method-signature">
          <span class="method-name">[]</span><span class="method-args">(jid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Get an item by jid
</p>
<p>
If not available tries to look for it with the resource stripped
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000173-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000173-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 239</span>
239:       <span class="ruby-keyword kw">def</span> <span class="ruby-operator">[]</span>(<span class="ruby-identifier">jid</span>)
240:         <span class="ruby-identifier">jid</span> = <span class="ruby-constant">JID</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">jid</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">jid</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">JID</span>
241: 
242:         <span class="ruby-ivar">@items_lock</span>.<span class="ruby-identifier">synchronize</span> {
243:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">jid</span>)
244:             <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">jid</span>]
245:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>)
246:             <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>]
247:           <span class="ruby-keyword kw">else</span>
248:             <span class="ruby-keyword kw">nil</span>
249:           <span class="ruby-keyword kw">end</span>
250:         }
251:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000178" class="method-detail">
        <a name="M000178"></a>

        <div class="method-heading">
          <a href="#M000178" class="method-signature">
          <span class="method-name">accept_subscription</span><span class="method-args">(jid, iname=nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Accept a subscription request
</p>
<ul>
<li>Sends a &lt;presence type=&#8216;subscribed&#8217;/&gt; stanza

</li>
<li>Adds the contact to your roster

</li>
</ul>
<table>
<tr><td valign="top">jid:</td><td>[<a href="../JID.html">JID</a>] of contact

</td></tr>
<tr><td valign="top">iname:</td><td>[String] Optional roster item name

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000178-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000178-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 342</span>
342:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">accept_subscription</span>(<span class="ruby-identifier">jid</span>, <span class="ruby-identifier">iname</span>=<span class="ruby-keyword kw">nil</span>)
343:         <span class="ruby-identifier">pres</span> = <span class="ruby-constant">Presence</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">set_type</span>(<span class="ruby-identifier">:subscribed</span>).<span class="ruby-identifier">set_to</span>(<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>)
344:         <span class="ruby-ivar">@stream</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">pres</span>)
345: 
346:         <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>]
347:           <span class="ruby-identifier">request</span> = <span class="ruby-constant">Iq</span>.<span class="ruby-identifier">new_rosterset</span>
348:           <span class="ruby-identifier">request</span>.<span class="ruby-identifier">query</span>.<span class="ruby-identifier">add</span>(<span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-constant">Roster</span><span class="ruby-operator">::</span><span class="ruby-constant">RosterItem</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>, <span class="ruby-identifier">iname</span>))
349:           <span class="ruby-ivar">@stream</span>.<span class="ruby-identifier">send_with_id</span>(<span class="ruby-identifier">request</span>) { <span class="ruby-keyword kw">true</span> }
350:         <span class="ruby-keyword kw">end</span>
351:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000177" class="method-detail">
        <a name="M000177"></a>

        <div class="method-heading">
          <a href="#M000177" class="method-signature">
          <span class="method-name">add</span><span class="method-args">(jid, iname=nil, subscribe=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a user to your roster
</p>
<p>
Threading is encouraged as the function waits for a result. <a
href="../ErrorException.html">ErrorException</a> is thrown upon error.
</p>
<p>
See <a
href="Helper/RosterItem.html#M000188">Jabber::Roster::Helper::RosterItem#subscribe</a>
for details about subscribing. (This method isn&#8216;t used here but the
same functionality applies.)
</p>
<p>
If the item is already in the local roster it will simply send itself
</p>
<table>
<tr><td valign="top">jid:</td><td>[<a href="../JID.html">JID</a>] to <a href="Helper.html#M000177">add</a>

</td></tr>
<tr><td valign="top">iname:</td><td>[String] Optional item name

</td></tr>
<tr><td valign="top">subscribe:</td><td>[Boolean] Whether to subscribe to this jid

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000177-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000177-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 318</span>
318:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add</span>(<span class="ruby-identifier">jid</span>, <span class="ruby-identifier">iname</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">subscribe</span>=<span class="ruby-keyword kw">false</span>)
319:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-identifier">jid</span>]
320:           <span class="ruby-keyword kw">self</span>[<span class="ruby-identifier">jid</span>].<span class="ruby-identifier">send</span>
321:         <span class="ruby-keyword kw">else</span>
322:           <span class="ruby-identifier">request</span> = <span class="ruby-constant">Iq</span>.<span class="ruby-identifier">new_rosterset</span>
323:           <span class="ruby-identifier">request</span>.<span class="ruby-identifier">query</span>.<span class="ruby-identifier">add</span>(<span class="ruby-constant">Jabber</span><span class="ruby-operator">::</span><span class="ruby-constant">Roster</span><span class="ruby-operator">::</span><span class="ruby-constant">RosterItem</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">jid</span>, <span class="ruby-identifier">iname</span>))
324:           <span class="ruby-ivar">@stream</span>.<span class="ruby-identifier">send_with_id</span>(<span class="ruby-identifier">request</span>) { <span class="ruby-keyword kw">true</span> }
325:           <span class="ruby-comment cmt"># Adding to list is handled by handle_iq</span>
326:         <span class="ruby-keyword kw">end</span>
327: 
328:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">subscribe</span>
329:           <span class="ruby-comment cmt"># Actually the item *should* already be known now,</span>
330:           <span class="ruby-comment cmt"># but we do it manually to exclude conditions.</span>
331:           <span class="ruby-identifier">pres</span> = <span class="ruby-constant">Presence</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">set_type</span>(<span class="ruby-identifier">:subscribe</span>).<span class="ruby-identifier">set_to</span>(<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>)
332:           <span class="ruby-ivar">@stream</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">pres</span>)
333:         <span class="ruby-keyword kw">end</span>
334:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000167" class="method-detail">
        <a name="M000167"></a>

        <div class="method-heading">
          <a href="#M000167" class="method-signature">
          <span class="method-name">add_presence_callback</span><span class="method-args">(prio = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a callback for <a href="../Presence.html">Jabber::Presence</a> updates
</p>
<p>
This will be called for <tt>&lt;presence/&gt;</tt> stanzas for known
RosterItems. Unknown JIDs may still pass and can be caught via <a
href="../Stream.html#M000451">Jabber::Stream#add_presence_callback</a>.
</p>
<p>
The block receives three objects:
</p>
<ul>
<li>the <a href="Helper/RosterItem.html">Jabber::Roster::Helper::RosterItem</a>

</li>
<li>the old <a href="../Presence.html">Jabber::Presence</a> (or nil)

</li>
<li>the <a href="Helper.html#M000164">new</a> <a
href="../Presence.html">Jabber::Presence</a> (or nil)

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000167-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000167-source">
<pre>
    <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 97</span>
97:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_presence_callback</span>(<span class="ruby-identifier">prio</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
98:         <span class="ruby-ivar">@presence_cbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">prio</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
99:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000165" class="method-detail">
        <a name="M000165"></a>

        <div class="method-heading">
          <a href="#M000165" class="method-signature">
          <span class="method-name">add_query_callback</span><span class="method-args">(prio = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a callback to be called when a query has been processed
</p>
<p>
Because update callbacks are called for each roster item, this may be
appropriate to notify that <b>anything</b> has updated.
</p>
<p>
Arguments for callback block: The received <tt>&lt;iq/&gt;</tt> stanza
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000165-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000165-source">
<pre>
    <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 70</span>
70:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_query_callback</span>(<span class="ruby-identifier">prio</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
71:         <span class="ruby-ivar">@query_cbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">prio</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
72:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000168" class="method-detail">
        <a name="M000168"></a>

        <div class="method-heading">
          <a href="#M000168" class="method-signature">
          <span class="method-name">add_subscription_callback</span><span class="method-args">(prio = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a callback for subscription updates, which will be called upon
receiving a <tt>&lt;presence/&gt;</tt> stanza with type:
</p>
<ul>
<li>:subscribed

</li>
<li>:unsubscribe

</li>
<li>:unsubscribed

</li>
</ul>
<p>
The block receives two objects:
</p>
<ul>
<li>the <a href="Helper/RosterItem.html">Jabber::Roster::Helper::RosterItem</a>
(or nil)

</li>
<li>the <tt>&lt;presence/&gt;</tt> stanza

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000168-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000168-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 112</span>
112:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_subscription_callback</span>(<span class="ruby-identifier">prio</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
113:         <span class="ruby-ivar">@subscription_cbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">prio</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
114:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000169" class="method-detail">
        <a name="M000169"></a>

        <div class="method-heading">
          <a href="#M000169" class="method-signature">
          <span class="method-name">add_subscription_request_callback</span><span class="method-args">(prio = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a callback for subscription requests, which will be called upon
receiving a <tt>&lt;presence type=&#8216;subscribe&#8217;/&gt;</tt> stanza
</p>
<p>
The block receives two objects:
</p>
<ul>
<li>the <a href="Helper/RosterItem.html">Jabber::Roster::Helper::RosterItem</a>
(or nil)

</li>
<li>the <tt>&lt;presence/&gt;</tt> stanza

</li>
</ul>
<p>
Response to this event can be taken with <a
href="Helper.html#M000178">accept_subscription</a> and <a
href="Helper.html#M000179">decline_subscription</a>.
</p>
<p>
Example usage:
</p>
<pre>
 my_roster.add_subscription_request_callback do |item,presence|
   if accept_subscription_requests
     my_roster.accept_subscription(presence.from)
   else
     my_roster.decline_subscription(presence.from)
   end
 end
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000169-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000169-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 135</span>
135:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_subscription_request_callback</span>(<span class="ruby-identifier">prio</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
136:         <span class="ruby-ivar">@subscription_request_cbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">prio</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
137:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000166" class="method-detail">
        <a name="M000166"></a>

        <div class="method-heading">
          <a href="#M000166" class="method-signature">
          <span class="method-name">add_update_callback</span><span class="method-args">(prio = 0, ref = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add a callback for <a
href="Helper/RosterItem.html">Jabber::Roster::Helper::RosterItem</a>
updates
</p>
<p>
Note that this will be called much after initialization for the answer of
the initial roster request
</p>
<p>
The block receives two objects:
</p>
<ul>
<li>the old <a
href="Helper/RosterItem.html">Jabber::Roster::Helper::RosterItem</a>

</li>
<li>the <a href="Helper.html#M000164">new</a> <a
href="Helper/RosterItem.html">Jabber::Roster::Helper::RosterItem</a>

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000166-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000166-source">
<pre>
    <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 83</span>
83:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_update_callback</span>(<span class="ruby-identifier">prio</span> = <span class="ruby-value">0</span>, <span class="ruby-identifier">ref</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
84:         <span class="ruby-ivar">@update_cbs</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">prio</span>, <span class="ruby-identifier">ref</span>, <span class="ruby-identifier">block</span>)
85:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000179" class="method-detail">
        <a name="M000179"></a>

        <div class="method-heading">
          <a href="#M000179" class="method-signature">
          <span class="method-name">decline_subscription</span><span class="method-args">(jid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Decline a subscription request
</p>
<ul>
<li>Sends a &lt;presence type=&#8216;unsubscribed&#8217;/&gt; stanza

</li>
</ul>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000179-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000179-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 356</span>
356:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decline_subscription</span>(<span class="ruby-identifier">jid</span>)
357:         <span class="ruby-identifier">pres</span> = <span class="ruby-constant">Presence</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">set_type</span>(<span class="ruby-identifier">:unsubscribed</span>).<span class="ruby-identifier">set_to</span>(<span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>)
358:         <span class="ruby-ivar">@stream</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">pres</span>)
359:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000174" class="method-detail">
        <a name="M000174"></a>

        <div class="method-heading">
          <a href="#M000174" class="method-signature">
          <span class="method-name">find</span><span class="method-args">(jid)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the list of RosterItems which, stripped, are equal to the one you
are looking for.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000174-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000174-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 256</span>
256:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find</span>(<span class="ruby-identifier">jid</span>)
257:         <span class="ruby-identifier">jid</span> = <span class="ruby-constant">JID</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">jid</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">jid</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">JID</span>
258: 
259:         <span class="ruby-identifier">j</span> = <span class="ruby-identifier">jid</span>.<span class="ruby-identifier">strip</span>
260:         <span class="ruby-identifier">l</span> = {}
261:         <span class="ruby-ivar">@items_lock</span>.<span class="ruby-identifier">synchronize</span> {
262:           <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
263:             <span class="ruby-identifier">l</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">j</span>
264:           <span class="ruby-keyword kw">end</span>
265:         }
266:         <span class="ruby-identifier">l</span>
267:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000176" class="method-detail">
        <a name="M000176"></a>

        <div class="method-heading">
          <a href="#M000176" class="method-signature">
          <span class="method-name">find_by_group</span><span class="method-args">(group)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Get items in a group
</p>
<p>
When group is nil, return ungrouped items
</p>
<table>
<tr><td valign="top">group:</td><td>[String] Group name

</td></tr>
<tr><td valign="top">result:</td><td>Array of [<a href="Helper/RosterItem.html">RosterItem</a>]

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000176-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000176-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 292</span>
292:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_by_group</span>(<span class="ruby-identifier">group</span>)
293:         <span class="ruby-identifier">res</span> = []
294:         <span class="ruby-ivar">@items_lock</span>.<span class="ruby-identifier">synchronize</span> {
295:           <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">jid</span>,<span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
296:             <span class="ruby-identifier">res</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">item</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">groups</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">group</span>)
297:             <span class="ruby-identifier">res</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">item</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">groups</span> <span class="ruby-operator">==</span> [] <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">group</span>.<span class="ruby-identifier">nil?</span>
298:           <span class="ruby-keyword kw">end</span>
299:         }
300:         <span class="ruby-identifier">res</span>
301:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000175" class="method-detail">
        <a name="M000175"></a>

        <div class="method-heading">
          <a href="#M000175" class="method-signature">
          <span class="method-name">groups</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Groups in this <a href="../Roster.html">Roster</a>, sorted by name
</p>
<p>
Contains <tt>nil</tt> if there are ungrouped items
</p>
<table>
<tr><td valign="top">result:</td><td>[Array] containing group names (String)

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000175-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000175-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 275</span>
275:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">groups</span>
276:         <span class="ruby-identifier">res</span> = []
277:         <span class="ruby-ivar">@items_lock</span>.<span class="ruby-identifier">synchronize</span> {
278:           <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">jid</span>,<span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
279:             <span class="ruby-identifier">res</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">groups</span>
280:             <span class="ruby-identifier">res</span> <span class="ruby-operator">+=</span> [<span class="ruby-keyword kw">nil</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">groups</span> <span class="ruby-operator">==</span> []
281:           <span class="ruby-keyword kw">end</span>
282:         }
283:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">to_s</span> }
284:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Private Instance methods</h3>

      <div id="method-M000170" class="method-detail">
        <a name="M000170"></a>

        <div class="method-heading">
          <a href="#M000170" class="method-signature">
          <span class="method-name">handle_iq</span><span class="method-args">(iq)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Handle received <tt>&lt;iq/&gt;</tt> stanzas, used internally
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000170-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000170-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 144</span>
144:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_iq</span>(<span class="ruby-identifier">iq</span>)
145:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">iq</span>.<span class="ruby-identifier">query</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">IqQueryRoster</span>)
146:           <span class="ruby-comment cmt"># If the &lt;iq/&gt; contains &lt;error/&gt; we just ignore that</span>
147:           <span class="ruby-comment cmt"># and assume an empty roster</span>
148:           <span class="ruby-identifier">iq</span>.<span class="ruby-identifier">query</span>.<span class="ruby-identifier">each_element</span>(<span class="ruby-value str">'item'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
149:             <span class="ruby-comment cmt"># Handle deletion of item</span>
150:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">subscription</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:remove</span>
151:               <span class="ruby-ivar">@items_lock</span>.<span class="ruby-identifier">synchronize</span> {
152:                 <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>)
153:               }
154: 
155:             <span class="ruby-keyword kw">else</span>
156:               <span class="ruby-identifier">olditem</span> = <span class="ruby-keyword kw">nil</span>
157:               <span class="ruby-ivar">@items_lock</span>.<span class="ruby-identifier">synchronize</span> {
158:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@items</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>)
159:                   <span class="ruby-identifier">olditem</span> = <span class="ruby-constant">RosterItem</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@stream</span>).<span class="ruby-identifier">import</span>(<span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>])
160: 
161:                   <span class="ruby-comment cmt"># Clear first, because import doesn't</span>
162:                   <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>].<span class="ruby-identifier">iname</span> = <span class="ruby-keyword kw">nil</span>
163:                   <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>].<span class="ruby-identifier">subscription</span> = <span class="ruby-keyword kw">nil</span>
164:                   <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>].<span class="ruby-identifier">ask</span> = <span class="ruby-keyword kw">nil</span>
165: 
166:                   <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>].<span class="ruby-identifier">import</span>(<span class="ruby-identifier">item</span>)
167:                 <span class="ruby-keyword kw">else</span>
168:                   <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>] = <span class="ruby-constant">RosterItem</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@stream</span>).<span class="ruby-identifier">import</span>(<span class="ruby-identifier">item</span>)
169:                 <span class="ruby-keyword kw">end</span>
170:               }
171:               <span class="ruby-ivar">@update_cbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">olditem</span>, <span class="ruby-ivar">@items</span>[<span class="ruby-identifier">item</span>.<span class="ruby-identifier">jid</span>])
172:             <span class="ruby-keyword kw">end</span>
173:           <span class="ruby-keyword kw">end</span>
174: 
175:           <span class="ruby-ivar">@query_cbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">iq</span>)
176:         <span class="ruby-keyword kw">else</span>
177:           <span class="ruby-keyword kw">false</span>
178:         <span class="ruby-keyword kw">end</span>
179:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000171" class="method-detail">
        <a name="M000171"></a>

        <div class="method-heading">
          <a href="#M000171" class="method-signature">
          <span class="method-name">handle_presence</span><span class="method-args">(pres)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Handle received <tt>&lt;presence/&gt;</tt> stanzas, used internally
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000171-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000171-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 184</span>
184:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_presence</span>(<span class="ruby-identifier">pres</span>)
185:         <span class="ruby-identifier">item</span> = <span class="ruby-keyword kw">self</span>[<span class="ruby-identifier">pres</span>.<span class="ruby-identifier">from</span>]
186: 
187:         <span class="ruby-keyword kw">if</span> [<span class="ruby-identifier">:subscribed</span>, <span class="ruby-identifier">:unsubscribe</span>, <span class="ruby-identifier">:unsubscribed</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">pres</span>.<span class="ruby-identifier">type</span>)
188:           <span class="ruby-ivar">@subscription_cbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">pres</span>)
189:           <span class="ruby-keyword kw">true</span>
190: 
191:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">pres</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:subscribe</span>
192:           <span class="ruby-ivar">@subscription_request_cbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">pres</span>)
193:           <span class="ruby-keyword kw">true</span>
194: 
195:         <span class="ruby-keyword kw">else</span>
196:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">nil?</span>
197:             <span class="ruby-identifier">update_presence</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">pres</span>)
198:             <span class="ruby-keyword kw">true</span>  <span class="ruby-comment cmt"># Callback consumed stanza</span>
199:           <span class="ruby-keyword kw">else</span>
200:             <span class="ruby-keyword kw">false</span> <span class="ruby-comment cmt"># Callback did not consume stanza</span>
201:           <span class="ruby-keyword kw">end</span>
202:         <span class="ruby-keyword kw">end</span>
203:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000172" class="method-detail">
        <a name="M000172"></a>

        <div class="method-heading">
          <a href="#M000172" class="method-signature">
          <span class="method-name">update_presence</span><span class="method-args">(item, pres)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Update the presence of an item, used internally
</p>
<p>
Callbacks are called here
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000172-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000172-source">
<pre>
     <span class="ruby-comment cmt"># File lib/xmpp4r/roster/helper/roster.rb, line 210</span>
210:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_presence</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">pres</span>)
211: 
212:         <span class="ruby-comment cmt"># This requires special handling, to announce all resources offline</span>
213:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pres</span>.<span class="ruby-identifier">from</span>.<span class="ruby-identifier">resource</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">pres</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:error</span>
214:           <span class="ruby-identifier">oldpresences</span> = []
215:           <span class="ruby-identifier">item</span>.<span class="ruby-identifier">each_presence</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">oldpres</span><span class="ruby-operator">|</span>
216:             <span class="ruby-identifier">oldpresences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">oldpres</span>
217:           <span class="ruby-keyword kw">end</span>
218: 
219:           <span class="ruby-identifier">item</span>.<span class="ruby-identifier">add_presence</span>(<span class="ruby-identifier">pres</span>)
220:           <span class="ruby-identifier">oldpresences</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">oldpres</span><span class="ruby-operator">|</span>
221:             <span class="ruby-ivar">@presence_cbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">oldpres</span>, <span class="ruby-identifier">pres</span>)
222:           }
223:         <span class="ruby-keyword kw">else</span>
224:           <span class="ruby-identifier">oldpres</span> = <span class="ruby-identifier">item</span>.<span class="ruby-identifier">presence</span>(<span class="ruby-identifier">pres</span>.<span class="ruby-identifier">from</span>).<span class="ruby-identifier">nil?</span> <span class="ruby-value">?
225: </span>            <span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span>
226:             <span class="ruby-constant">Presence</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">import</span>(<span class="ruby-identifier">item</span>.<span class="ruby-identifier">presence</span>(<span class="ruby-identifier">pres</span>.<span class="ruby-identifier">from</span>))
227: 
228:           <span class="ruby-identifier">item</span>.<span class="ruby-identifier">add_presence</span>(<span class="ruby-identifier">pres</span>)
229:           <span class="ruby-ivar">@presence_cbs</span>.<span class="ruby-identifier">process</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">oldpres</span>, <span class="ruby-identifier">pres</span>)
230:         <span class="ruby-keyword kw">end</span>
231:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>